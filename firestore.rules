
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }

    function getUserRole() {
      return getUserData().role;
    }

    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }

    function isLector() {
        return isSignedIn() && getUserRole() == 'lector';
    }
    
    function isEmpleado() {
        return isSignedIn() && getUserRole() == 'empleado';
    }

    function canRead() {
        return isAdmin() || isLector();
    }
    
    // Reglas para la activación de la cuenta
    match /Plantilla/{empleadoId} {
      allow read: if true; // Permitir lectura pública para verificar ID
      allow write: if isAdmin(); // Solo admins pueden modificar la plantilla
    }
    
    match /usuarios/{userId} {
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      allow create: if true; // Permitir que cualquiera cree su documento de usuario al registrarse
      allow update, delete: if isAdmin() || (request.auth != null && request.auth.uid == userId);
    }
    
    match /Contratos/{contratoId} {
      allow read: if canRead();
      allow write: if isAdmin();
    }

    match /reports/{reportId} {
      allow read: if canRead();
      allow write: if isAdmin();
    }

    match /catalogo_cursos/{cursoId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /preguntas_limpias/{preguntaId} {
        allow read: if isSignedIn(); 
    }

    match /perfiles_puesto/{puestoId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /examenes/{puestoId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }

    match /historial_capacitacion/{empleadoId} {
        allow get: if canRead() || (isEmpleado() && getUserData().id_empleado == empleadoId);
        allow list: if canRead();
        allow write: if isAdmin();
    }
    
    match /Promociones/{empleadoId} {
      allow list: if canRead();
      allow get: if canRead() || (isEmpleado() && getUserData().id_empleado == empleadoId);
      allow write: if isAdmin();
    }
    
    match /Promociones/{empleadoId}/intentos_examen/{intentoId} {
        allow read: if canRead();
        allow create: if isEmpleado() && request.auth.uid == get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.uid;
        allow write: if isAdmin();
    }

    match /plan_formacion/{planId} {
        allow read: if canRead();
        allow write: if isAdmin();
    }

    match /programa_anual/{programaId} {
        allow read: if canRead();
        allow write: if isAdmin();
    }

    match /reglas_ascenso/{reglaId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /vacaciones/{vacacionId} {
        allow read: if canRead();
        allow write: if isAdmin();
    }

    match /dias_festivos/{diaId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    match /cursos/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && get(/databases/(default)/documents/usuarios/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
